[globals]
FINDME_ENABLED=true
FINDME_COUNT=2
FINDME_EXT[0]=6003
FINDME_RING[0]=20
FINDME_EXT[1]=6004
FINDME_RING[1]=30

[from-internal]
; Normal call - call transfer
exten => _X.,1,NoOp(Call Entry DNIS=${EXTEN})
 same => n,NoOp(=== This is the main entry point ===)
 same => n,NoOp("This is the main entry point")
 same => n,Dial(PJSIP/6002,20,g)
 same => n,Verbose("After Dial: DIALSTATUS=${DIALSTATUS}")

 ; ------------------------------------------------------------------
 ; Parallel Find-Me example
 ; Dial extension 7000 to ring multiple PJSIP endpoints simultaneously.
 ; This demonstrates "parallel ringing" (simultaneous ring) of multiple
 ; endpoints using the `&` list in Dial(). Asterisk will attempt to ring
 ; all specified endpoints at once. If some endpoints are not registered
 ; or have no active contacts, they will typically be skipped by PJSIP.
 ; ------------------------------------------------------------------
 exten => 7000,1,NoOp(Parallel Find-Me: Ring multiple endpoints simultaneously)
	same => n,Verbose("Parallel Find-Me example: attempting to ring 6003 & 6004")
	same => n,Set(RING_TIME=30)
	; Build the simultaneous dial string here. Add more endpoints separated
	; by '&' if desired: e.g. PJSIP/6003&PJSIP/6004&PJSIP/6005
	same => n,Set(DIAL_TARGETS=PJSIP/6003&PJSIP/6004)
	; Dial the targets simultaneously. The 'g' option returns to dialplan on
	; answer so we can inspect DIALSTATUS. Adjust options as needed.
	same => n,Dial(${DIAL_TARGETS},${RING_TIME},g)
	same => n,Verbose("Parallel Dial finished: DIALSTATUS=${DIALSTATUS}")
	; If answered, jump to end. Otherwise reuse the existing call_failed
	; handling (which will check FINDME_ENABLED and continue sequential
	; find-me if enabled, or go to voicemail).
	same => n,GotoIf($["${DIALSTATUS}"="ANSWER"]?end:call_failed)


 ; Only handle failed or non-answered calls here
 same => n,GotoIf($["${DIALSTATUS}"="ANSWER"]?end:call_failed)

 same => n(call_failed),Verbose("Call failed or not answered: ${DIALSTATUS}")
 same => n,GotoIf($["${FINDME_ENABLED}" == "true"]?findme_enabled:findme_skip)

 same => n(findme_enabled),Verbose("Running find-me sequence...")
 same => n,Set(CTR=0)
 same => n(loop),While($[${CTR} < ${FINDME_COUNT}])
 same => n,Set(NUMBER_TO_DIAL=${FINDME_EXT[${CTR}]})
 same => n,Set(NUMBER_OF_RING=${FINDME_RING[${CTR}]})
 same => n,Gosub(make-dial,s,1)
 same => n,Verbose("DIALSTATUS is ${DIALSTATUS}")

 ; "Break" out of loop if answered
 same => n,ExecIf($["${DIALSTATUS}"="ANSWER"]?Goto(findme_skip))

 same => n,Set(CTR=$[${CTR} + 1])
 same => n,EndWhile()

 same => n(end_loop),Verbose("Find-me loop ended. Go to Voicemail.")
 same => n(voicemail),Verbose("Executing voicemail")
 same => n,Verbose("Please record after the tone, when finished press the pound key.")
 same => n,Playback(vm-intro)
 same => n,Wait(1)
 same => n,Playback(beep)
 same => n,Record(/var/spool/asterisk/voicemail/tmp/${UNIQUEID}.wav,5,60)
 same => n,Playback(vm-goodbye)
 same => n,Goto(end)

 same => n(findme_skip),Verbose("Skipping find-me for ${EXTEN}")
 same => n(end),Hangup()

exten => h,1,Verbose("Hanging up call.")
 same => n,Verbose("DIALSTATUS is ${DIALSTATUS}")

[make-dial]
; Make a dial here.
exten => s,1,Verbose("Attempt to dial")
 ; Attempt to Dial findme entries.
 same => n,Dial(PJSIP/${NUMBER_TO_DIAL},${NUMBER_OF_RING},g)
 same => n,Return()
