[globals]
FINDME_ENABLED=true
FINDME_COUNT=2
FINDME_EXT[0]=6003
FINDME_RING[0]=20
FINDME_EXT[1]=6004
FINDME_RING[1]=30

[from-internal]
; Normal call - call transfer
exten => _X.,1,NoOp(Call Entry DNIS=${EXTEN})
 same => n,NoOp(=== This is the main entry point ===)
 same => n,NoOp("This is the main entry point")
 same => n,Dial(PJSIP/6002,20,g)
 same => n,Verbose("After Dial: DIALSTATUS=${DIALSTATUS}")

 ; Only handle failed or non-answered calls here
 same => n,GotoIf($["${DIALSTATUS}"="ANSWER"]?end:call_failed)

 same => n(call_failed),Verbose("Call failed or not answered: ${DIALSTATUS}")
 same => n,GotoIf($["${FINDME_ENABLED}" == "true"]?findme_enabled:findme_skip)

 same => n(findme_enabled),Verbose("Running find-me sequence...")
 same => n,Set(CTR=0)
 same => n(loop),While($[${CTR} < ${FINDME_COUNT}])
 same => n,Set(NUMBER_TO_DIAL=${FINDME_EXT[${CTR}]})
 same => n,Set(NUMBER_OF_RING=${FINDME_RING[${CTR}]})
 same => n,Gosub(make-dial,s,1)
 same => n,Verbose("DIALSTATUS is ${DIALSTATUS}")

 ; "Break" out of loop if answered
 same => n,ExecIf($["${DIALSTATUS}"="ANSWER"]?Goto(end_loop))

 same => n,Set(CTR=$[${CTR} + 1])
 same => n,EndWhile()

 same => n(end_loop),Verbose("Find-me loop ended")
 same => n,Goto(end)

 same => n(findme_skip),Verbose("Skipping find-me for ${EXTEN}")
 same => n(end),Hangup()

exten => h,1,Verbose("Hanging up call.")
 same => n,Verbose("DIALSTATUS is ${DIALSTATUS}")

[make-dial]
; Make a dial here.
exten => s,1,Verbose("Attempt to dial")
 ; Attempt to Dial findme entries.
 same => n,Dial(PJSIP/${NUMBER_TO_DIAL},${NUMBER_OF_RING},g)
 same => n,Return()
